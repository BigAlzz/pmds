{% extends 'performance/base.html' %}
{% load static %}

{% block title %}Audit Trail - Performance Management System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .audit-action-badge {
        min-width: 100px;
    }
    .filter-card {
        margin-bottom: 1.5rem;
    }
    .audit-row {
        cursor: pointer;
    }
    .audit-row:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Audit Trail</h4>
                    <div>
                        <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                    </div>
                </div>
                <div class="collapse" id="filterCollapse">
                    <div class="card-body bg-light">
                        <form method="get" action="{% url 'performance:audit_trail_list' %}">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="user_id" class="form-label">User</label>
                                        <select class="form-select" id="user_id" name="user_id">
                                            <option value="">All Users</option>
                                            {% for user in users %}
                                            <option value="{{ user.id }}" {% if filters.user_id == user.id|stringformat:"i" %}selected{% endif %}>
                                                {{ user.get_full_name }} ({{ user.email }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="action_type" class="form-label">Action Type</label>
                                        <select class="form-select" id="action_type" name="action_type">
                                            <option value="">All Actions</option>
                                            {% for action in action_types %}
                                            <option value="{{ action }}" {% if filters.action_type == action %}selected{% endif %}>
                                                {{ action }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="date_from" class="form-label">Date From</label>
                                        <input type="text" class="form-control datepicker" id="date_from" name="date_from" value="{{ filters.date_from }}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="date_to" class="form-label">Date To</label>
                                        <input type="text" class="form-control datepicker" id="date_to" name="date_to" value="{{ filters.date_to }}">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="q" class="form-label">Search</label>
                                        <input type="text" class="form-control" id="q" name="q" placeholder="Search in details, object, user..." value="{{ filters.q }}">
                                    </div>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <div class="mb-3">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> Apply Filters
                                        </button>
                                        <a href="{% url 'performance:audit_trail_list' %}" class="btn btn-secondary">
                                            <i class="fas fa-times"></i> Clear Filters
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Object</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in page_obj %}
                                <tr class="audit-row" onclick="window.location='{% url 'performance:audit_trail_detail' entry.id %}'">
                                    <td>{{ entry.timestamp|date:"M d, Y H:i:s" }}</td>
                                    <td>{{ entry.user.get_full_name }}</td>
                                    <td>
                                        <span class="badge audit-action-badge bg-{{ entry.action|lower }}">
                                            {{ entry.action }}
                                        </span>
                                    </td>
                                    <td>{{ entry.object_repr|truncatechars:30 }}</td>
                                    <td>{{ entry.details|truncatechars:50 }}</td>
                                    <td>{{ entry.ip_address }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No audit trail entries found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="Audit trail pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <a class="page-link" href="#">{{ num }}</a>
                                </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date pickers
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true
        });
        
        // Show filter collapse if any filter is applied
        if ({% if filters.user_id or filters.action_type or filters.date_from or filters.date_to or filters.q %}true{% else %}false{% endif %}) {
            new bootstrap.Collapse(document.getElementById('filterCollapse')).show();
        }
    });
</script>
{% endblock %} 